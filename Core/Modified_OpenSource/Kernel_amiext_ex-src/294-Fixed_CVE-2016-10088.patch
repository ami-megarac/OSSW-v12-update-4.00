--- linux_patch290/block/bsg.c	2020-03-24 18:06:16.267586600 +0800
+++ linux/block/bsg.c	2020-03-25 16:38:06.279027366 +0800
@@ -674,6 +674,9 @@
 	int ret;
 
 	dprintk("%s: write %Zd bytes\n", bd->name, count);
+	
+	if (unlikely(segment_eq(get_fs(), KERNEL_DS)))
+		return -EINVAL;
 
 	bsg_set_block(bd, file);
 
--- linux_patch290/drivers/scsi/sg.c	2020-03-24 18:07:51.959671014 +0800
+++ linux/drivers/scsi/sg.c	2020-03-25 16:39:03.687034415 +0800
@@ -568,6 +568,9 @@
 	sg_io_hdr_t *hp;
 	unsigned char cmnd[MAX_COMMAND_SIZE];
 
+	if (unlikely(segment_eq(get_fs(), KERNEL_DS)))
+		return -EINVAL;
+
 	if ((!(sfp = (Sg_fd *) filp->private_data)) || (!(sdp = sfp->parentdp)))
 		return -ENXIO;
 	SCSI_LOG_TIMEOUT(3, printk("sg_write: %s, count=%d\n",
