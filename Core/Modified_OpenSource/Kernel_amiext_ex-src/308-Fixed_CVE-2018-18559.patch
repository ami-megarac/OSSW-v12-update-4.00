--- linux_patch307/net/packet/af_packet.c	2020-03-30 10:40:50.765176725 +0800
+++ linux/net/packet/af_packet.c	2020-03-30 11:50:00.628200759 +0800
@@ -2672,8 +2672,13 @@
 	need_rehook = proto_curr != proto || dev_curr != dev;
 
 	if (need_rehook) {
+		/* prevents packet_notifier() from calling
+		 * register_prot_hook()
+		 */
+		po->num = 0;
 		unregister_prot_hook(sk, true);
 
+		BUG_ON(po->running);
 		po->num = proto;
 		po->prot_hook.type = proto;
 
